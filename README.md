# Простой доступ к MongoDB для ИИ-помощника (с поддержкой MCP)

Этот инструмент позволяет вашему ИИ-помощнику (например, в Cursor IDE, Claude Desktop или другом клиенте, поддерживающем Model Context Protocol - MCP) безопасно взаимодействовать с вашей базой данных MongoDB.

## Что нужно заранее?

Прежде чем начать, убедитесь, что у вас есть:

1.  **Клиент с поддержкой MCP:** Например, Cursor IDE. Установленный и рабочий.
2.  **Доступ к MongoDB:** Вам нужна строка подключения (URI) к вашему серверу MongoDB и имя базы данных, с которой будет работать инструмент.
3.  **Инструмент Go:** Это язык программирования. Если у вас его нет, его нужно установить. Инструкции по установке ниже, в разделе "Сборка программы".
4.  **Код этой программы:** Все файлы из этого репозитория (`mcpmongo`) должны быть скачаны и находиться в одной папке.

## Как запустить (По шагам)

**Шаг 1: Установка Go (если еще не установлен)**

*   Перейдите на официальный сайт Go: [golang.dev/dl/](https://golang.dev/dl/)
*   Скачайте установщик для вашей операционной системы (Windows, macOS, Linux).
*   Запустите установщик и следуйте его инструкциям.
*   После установки откройте **новый** Терминал и введите команду `go version`. Если вы видите версию Go (например, `go version go1.23.0 darwin/amd64`), значит, установка прошла успешно.

**Шаг 2: Настройка переменных окружения**

Для работы программы необходимо установить следующие переменные окружения:

*   `MCPMONGO_MONGO_URI`: Строка подключения к вашему MongoDB.  
    *   Пример: `mongodb://user:password@host:port/` или `mongodb+srv://user:password@clustername.mongodb.net/`
*   `MCPMONGO_DATABASE_NAME`: Имя базы данных MongoDB, с которой будет работать инструмент.
*   `MCPMONGO_SERVER_PORT` (опционально): Порт, на котором будет слушать MCP-сервер, если вы решите запускать его не через Stdio, а как TCP-сервер (текущая реализация `main.go` использует Stdio, но порт зарезервирован для будущих изменений). По умолчанию `26275`.

Вы можете установить их в вашем терминале перед запуском или добавить в конфигурационный файл вашей оболочки (например, `.zshrc`, `.bashrc`).

Пример для терминала (значения нужно заменить на ваши):

```bash
export MCPMONGO_MONGO_URI="mongodb://localhost:27017/"
export MCPMONGO_DATABASE_NAME="mydatabase"
# export MCPMONGO_SERVER_PORT="26275" # Опционально
```

**Шаг 3: Сборка программы**

1.  Откройте Терминал.
2.  Перейдите в папку с кодом программы (туда, где лежит `main.go` и другие файлы этого проекта). Например:
    ```bash
    cd /путь/к/вашей/папке/mcpmongo
    ```
3.  Выполните команду для загрузки зависимостей (если вы не делали этого ранее):
    ```bash
    go mod tidy
    ```
4.  Теперь соберите программу. Выполните команду:
    ```bash
    go build -o mcp_mongo_server main.go
    ```
    Эта команда создаст исполняемый файл `mcp_mongo_server` (или `mcp_mongo_server.exe` на Windows) в текущей папке. Флаг `-tags netgo` здесь не обязателен, так как MongoDB драйвер обычно не имеет таких же проблем со статическими сборками, как некоторые CGO-зависимые драйверы баз данных.

**Шаг 4: Интеграция с MCP клиентом (например, Cursor IDE)**

Интеграция зависит от вашего MCP клиента. Обычно это включает в себя указание пути к исполняемому файлу `mcp_mongo_server`.

Для Cursor IDE (примерный путь, может отличаться):

1.  Откройте настройки Cursor (`Cmd + ,` или `Ctrl + ,`).
2.  Перейдите в раздел "MCP Servers" или найдите соответствующую настройку для пользовательских MCP серверов.
3.  Добавьте новый сервер:
    *   **Name:** `mongodb` (или любое другое имя)
    *   **Command:** Укажите **полный путь** к собранному файлу `mcp_mongo_server`.  
        Например: `/Users/yourname/dev/mcpmongo/mcp_mongo_server`
    *   **Environment Variables:** Убедитесь, что переменные `MCPMONGO_MONGO_URI` и `MCPMONGO_DATABASE_NAME` доступны для процесса сервера. Если ваш MCP-клиент позволяет указывать переменные окружения для сервера, задайте их там. В противном случае, убедитесь, что они установлены глобально или в профиле вашей оболочки, из которой запускается Cursor.

**Шаг 5: Перезапустите MCP клиент**

После сохранения конфигурации полностью перезапустите ваш MCP клиент (например, Cursor IDE), чтобы он обнаружил и запустил новый сервер.

**Шаг 6: Используйте в ИИ-помощнике**

Теперь ваш ИИ-помощник должен "видеть" новый инструмент с именем `mongodb` и его инструмент `execute_mongo_command`.

Вы можете попросить его:

>   "Выполни команду MongoDB `{\"ping\": 1}`"
>   "Найди документы в коллекции `users` с фильтром `{\"age\": {\"$gt\": 30}}` используя `execute_mongo_command` для `mongodb`."

## Принцип работы инструмента `execute_mongo_command`

Инструмент `execute_mongo_command` принимает один строковый параметр `command`. Эта строка должна быть валидным JSON, представляющим команду MongoDB, которую нужно выполнить с помощью `db.runCommand()`.

**Важно:**
*   **Порядок ключей:** Для команд MongoDB, где порядок ключей имеет значение (например, команда `find` с несколькими опциями, или `aggregate`), важно передавать JSON, в котором ключи указаны в ожидаемом MongoDB порядке. Сервер `mcp_mongo_server` использует специальный тип (`bson.D`) для разбора JSON, чтобы сохранить порядок ключей. Если вы столкнулись с ошибкой "multi-key map passed in for ordered parameter cmd", скорее всего, проблема именно в порядке ключей в вашем JSON запросе.
*   **Результаты с курсором:** Для команд, возвращающих несколько документов (например, `find`), результат будет обернут в объект курсора. Сами документы обычно находятся в поле `cursor.firstBatch` ответа.

**Примеры команд:**

Чтобы взаимодействовать с коллекциями, вы можете использовать различные команды MongoDB внутри JSON. Вот несколько распространенных примеров, которые должны корректно работать с текущей реализацией:

*   Пинг сервера: `{"ping": 1}`
*   Получение списка коллекций: `{"listCollections": 1}` (можно добавить `"nameOnly": true`, если нужно только имена)
*   Поиск документов в коллекции `users` (возвращает курсор, первые N документов будут в `cursor.firstBatch`): `{"find": "users", "filter": {"age": {"$gt": 30}}}`
*   Поиск первых 5 документов в коллекции `products`: `{"find": "products", "filter": {"sku": "XYZ123"}, "limit": 5}`
*   Подсчет количества документов в коллекции `orders`: `{"count": "orders", "query": {"status": "processed"}}`
*   Агрегация (пример): `{"aggregate": "имя_коллекции", "pipeline": [{"$match": {"статус": "A"}}, {"$group": {"_id": "$cust_id", "total": {"$sum": "$amount"}}}], "cursor": {}}` (результат также будет в `cursor.firstBatch`)
*   Получение статистики коллекции: `{"collStats": "имя_коллекции"}`

Результат выполнения команды также возвращается в виде JSON.

## Если что-то не работает

*   **Индикатор подключения не горит / Сервер не виден в настройках?**
    *   Перепроверьте **полный путь** к программе `mcp_mongo_server` в конфигурационном файле вашего MCP клиента.
    *   Убедитесь, что вы точно перезапустили ваш MCP клиент после сохранения конфигурации.
    *   Проверьте, правильно ли установлены переменные окружения `MCPMONGO_MONGO_URI` и `MCPMONGO_DATABASE_NAME`. Программа завершится с ошибкой, если они не найдены.
    *   Проверьте логи вашего MCP клиента (например, `View` -> `Output` -> `Cursor MCP` в Cursor) на наличие ошибок при попытке запуска сервера.
*   **Помощник говорит, что не может выполнить запрос?**
    *   Убедитесь, что строка подключения MongoDB (`MCPMONGO_MONGO_URI`) верна и у указанного пользователя достаточно прав для выполнения команд в целевой базе данных (`MCPMONGO_DATABASE_NAME`).
    *   Проверьте правильность JSON-синтаксиса в передаваемой команде.

## Как добавить новые команды для ИИ (Расширение функциональности)

Текущая версия предоставляет один универсальный инструмент `execute_mongo_command`. Вы можете расширить функциональность, добавив более специфичные инструменты (например, `list_collections`, `find_one_document` и т.д.) по аналогии с тем, как это сделано для `execute_mongo_command` в файле `main.go`. Обратитесь к документации `github.com/mark3labs/mcp-go` для получения дополнительной информации о создании инструментов. 